#Clash 主设置文件路径
settings="/data/adb/clash/settings.ini"

#确保 busybox 可用
if ! command -v busybox &> /dev/null; then
  export PATH="/data/adb/magisk:/data/adb/ksu/bin:/data/adb/ap/bin:$PATH:/system/bin"
fi

#当前时间，仅用于日志前缀
current_time=$(date +"%H:%M")

#透明代理端口定义
tproxy_port="9898"    #TPROXY 模式使用
redir_port="9797"     #REDIRECT 模式使用

#是否启用 IPv6
ipv6="false"

#可用内核列表
bin_list=("clash")

#扩展内核类型
xclash_option="mihomo"

#实际启动的核心名称
bin_name="clash"

#Clash 核心进程运行的用户与组
box_user_group="root:net_admin"

#网络代理模式
network_mode="tun"

#Clash 根目录
box_dir="/data/adb/clash"

#运行时目录
box_run="${box_dir}/run"

#模块运行日志
box_log="${box_run}/runs.log"

#Clash 核心 PID 文件
box_pid="${box_run}/box.pid"

#核心二进制目录与完整路径
bin_dir="${box_dir}/bin"
bin_path="${bin_dir}/${bin_name}"

#Clash 核心自身日志
bin_log="${box_run}/${bin_name}.log"
#bin_log="/dev/null"   #可用于完全关闭核心日志

#Android 系统包 UID 映射文件
system_packages_file="/data/system/packages.list"

#需要代理的应用 UID 列表
uid_list=("/data/adb/clash/run/appuid.list")

#订阅 / 定时更新
interva_update="0 0,6,12,18 * * *"
run_crontab="false"
update_geo="false"
renew="false"
update_subscription="false"

subscription_url_clash=(
  "http://127.0.0.1:12345/api/file/clash1.yaml"
)

name_clash_config="config.yaml"
clash_config="${box_dir}/clash/${name_clash_config}"

name_provide_clash_config=("subscription.yaml")
clash_provide_path="${box_dir}/clash/subscription"

custom_rules_subs="false"
name_provide_clash_rules="rules.yaml"
clash_provide_rules="${box_dir}/clash/subscription/${name_provide_clash_rules}"

#网络接口白名单配置
write_listap=$(dirname "$settings")/ap.list.cfg

#若存在同名目录则清理
[ -d ${write_listap} ] && rm -rf ${write_listap}

#若配置文件不存在则初始化
[ ! -f ${write_listap} ] && cat > ${write_listap} <<EOF
allow ap+
allow wlan+
allow rndis+
allow swlan+
allow ncm+
allow eth+
EOF

#解析允许输出的网络接口前缀
ap_list=($(busybox awk '/^allow / {print $2}' ${write_listap}))

#解析需要忽略的接口
ignore_out_list=($(busybox awk '/^ignore / {print $2}' ${write_listap}))

#GID 黑白名单配置
gid_config=$(dirname "$settings")/gid.list.cfg
[ -d ${gid_config} ] && rm -rf ${gid_config}
[ ! -f ${gid_config} ] && cat > ${gid_config} <<EOF
EOF

#应用包名黑白名单配置
pkg_config=$(dirname "$settings")/package.list.cfg
[ -d ${pkg_config} ] && rm -rf ${pkg_config}
[ ! -f ${pkg_config} ] && cat > ${pkg_config} <<EOF
mode:blacklist
EOF

#代理模式
proxy_mode=$(sed -n 's/^mode:\([^ ]*\).*/\1/p' ${pkg_config})

#应用包名列表
packages_list=($(sed -n '/^[^#]/s/^\([^ ]*\.[^ ]*\).*/\1/p' ${pkg_config}))

#GID 列表
gid_list=($(busybox awk '!/^#/ && /^[0-9]+$/ {print $1}' ${gid_config}))

#网络状态联动
enable_network_service_control=false
use_module_on_wifi_disconnect=true
use_module_on_wifi=false

#Wi-Fi SSID 匹配
use_ssid_matching=false
use_wifi_list_mode="blacklist"
wifi_ssids_list=("WiFi1" "WiFi-2" "WiFi 3")

#inotify 调试日志开关
inotify_log_enabled="true"

#1. 自动网络优化模式
network_optimization_mode="bond1"

#2. cgroup 资源限制配置
#内存限制
memcg_limit="256M"
#允许使用的 CPU 核心（如 0-1 表示仅用前2核，默认自动检测）
allow_cpu=""
#I/O 权重
blkio_weight="900"

#3. 下载配置优化
#是否启用 GitHub 加速代理
use_ghproxy="true"
#自定义 GitHub 加速地址
ghproxy_url="https://ghfast.top"
#下载失败重试次数（默认2次）
download_retry="2"
#下载超时时间
download_timeout="60"

#4. 日志配置
#日志级别（debug/info/warn/error，默认info）
log_level="info"
#日志轮转大小（超过自动分割，默认10M）
log_rotate_size="10M"
#日志保留天数（默认3天）
log_keep_days="3"

#5. 内核更新配置
#优先更新 mihomo 稳定版
mihomo_stable="enable"
#是否自动更新内核
auto_update_kernel="false"

#6. TUN 模式优化
#TUN 接口 MTU
tun_mtu="1500"
#自动配置路由
tun_auto_route="true"
#自动配置 DNS
tun_auto_dns="true"

#7. 应用代理精细化控制
#是否代理系统应用
proxy_system_apps="true"
#是否代理 Root 权限应用
proxy_root_apps="true"

#空通知函数
notify() {
  true
}

#统一日志函数
log() {
  message="${current_time} [$1]: $2"

  if [ -t 1 ]; then
    echo "${message}"
  else
    echo "${message}" | tee -a "${box_log}"
  fi

  if [[ $TOAST ]]; then
      notify "ClashForRoot" "${message}"
  fi
}
